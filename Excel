Imports System.Data.SqlClient
Imports Microsoft.Office.Interop.Excel

Public Class UserControl1

    Dim connectionString As String = "Data Source=TuServidor;Initial Catalog=TuBaseDeDatos;Integrated Security=True"
    Dim dt As New Data.DataTable()
    Dim headersLoaded As Boolean = False ' Bandera para controlar si las cabeceras ya se cargaron



    Private Sub DataGridView1_CellContentClick(sender As Object, e As DataGridViewCellEventArgs) Handles DataGridView1.CellContentClick

    End Sub

    Private Sub Button1_Click(sender As Object, e As EventArgs) Handles Button1.Click
        Dim openFileDialog As New OpenFileDialog()
        openFileDialog.Filter = "Archivos de Excel|*.xls;*.xlsx"
        If openFileDialog.ShowDialog() = DialogResult.OK Then
            Dim excelApp As New Application()
            Dim workbook As Workbook = excelApp.Workbooks.Open(openFileDialog.FileName)
            Dim worksheet As Worksheet = DirectCast(workbook.Sheets(1), Worksheet)

            If Not headersLoaded Then ' Si las cabeceras a√∫n no se han cargado, agregarlas
                Dim firstRow As Range = worksheet.UsedRange.Rows(1)
                For Each cell As Range In firstRow.Cells
                    dt.Columns.Add(cell.Value)
                Next
                headersLoaded = True
            End If

            dt.Clear()

            For row As Integer = If(headersLoaded, 2, 1) To worksheet.UsedRange.Rows.Count
                Dim newRow As DataRow = dt.NewRow()
                For col As Integer = 1 To worksheet.UsedRange.Columns.Count
                    newRow(col - 1) = worksheet.Cells(row, col).Value
                Next
                dt.Rows.Add(newRow)
            Next

            DataGridView1.DataSource = dt

            excelApp.Quit()
        End If
    End Sub

    Private Sub Button2_Click(sender As Object, e As EventArgs) Handles Button2.Click
        Dim connectionString As String = "Data Source=TuServidor;Initial Catalog=TuBaseDeDatos;Integrated Security=True"
        Dim connection As New SqlConnection(connectionString)
        Dim adapter As New SqlDataAdapter()

        connection.Open()

        For Each row As DataRow In dt.Rows
            Dim columnNames As String = String.Join(", ", dt.Columns.Cast(Of DataColumn)().Select(Function(column) column.ColumnName))
            Dim parameterNames As String = String.Join(", ", dt.Columns.Cast(Of DataColumn)().Select(Function(column) "@" & column.ColumnName))
            Dim commandText As String = $"INSERT INTO TuTabla ({columnNames}) VALUES ({parameterNames})"
            Dim command As New SqlCommand(commandText, connection)

            For Each column As DataColumn In dt.Columns
                command.Parameters.AddWithValue("@" & column.ColumnName, row(column))
            Next

            command.ExecuteNonQuery()
        Next

        connection.Close()
        MessageBox.Show("Datos guardados correctamente.")
    End Sub
End Class
