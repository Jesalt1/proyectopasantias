SELECT        compania,  departamento, anio, mes, sueldo, sobretiempo, comision, alimentacion, otro, reembolso, difsal, vaca, FR, xiii, xiv, ingreso, 
--iva, ingreso + iva AS total_factura, 
aporte_iess, 
                         prestamo_quirografario, prestamo_hipotecario, prestamo, afpgenesis, admprevenir, cafeteria, celular, imp_renta, desct_varios, 
						 --valor_ret_iva, ret_fuente, valor_anticipo, valor_mes, 
						 antimp_renta, mesimp_renta, leysolidaridad, 
                         leyh, sueldo_nominal
FROM            (SELECT        compania, departamento,  anio, mes,  --por_iva, por_ret_iva, por_ret_fuente, 
sueldo, sueldo_nominal, sobretiempo, comision, alimentacion, otro, reembolso, difsal, vaca, FR, xiii, xiv, 
                                                    sueldo_nominal + sobretiempo + comision + alimentacion + otro + reembolso + difsal + vaca + FR + xiii + xiv AS ingreso, 
													--iva,
													aporte_iess, prestamo_quirografario, prestamo_hipotecario, prestamo, afpgenesis, 
                                                    admprevenir, cafeteria, celular, imp_renta, desct_varios, 
													--valor_ret_iva, ret_fuente, 
													--valor_anticipo, valor_mes - ret_fuente AS valor_mes, 
													antimp_renta, mesimp_renta, leysolidaridad, leyh
                          FROM            (SELECT        compania, departamento, anio, mes,  --por_iva, por_ret_iva, por_ret_fuente, 
						  antsueldo + messueldo AS sueldo, antsueldoleyh + messueldoleyh AS sueldo_nominal, 
                                                                              antsobretiempo + messobretiempo AS sobretiempo, antcomision + mescomision AS comision, antalimentacion + mesalimentacion AS alimentacion, antotro + mesotro AS otro, 
                                                                              antreembolso + mesreembolso AS reembolso, antdifsal + mesdifsal AS difsal, antvaca + mesvaca AS vaca, adeiva + mesiva AS iva2, antFR + mesFR AS FR, antxiii + mesxiii AS xiii, 
                                                                              antxiv + mesxiv AS xiv, 
																		--	  (CASE WHEN CH01CLASE = 'S' THEN (((antsueldoleyh + messueldoleyh) + (antotro + mesotro)) * (por_iva * 0.01)) ELSE 0 END) AS iva, 
																			  antaporte_iess + mesaporte_iess AS aporte_iess, 
                                                                              antprestamo_quirografario + mesprestamo_quirografario AS prestamo_quirografario, antprestamo_hipotecario + mesprestamo_hipotecario AS prestamo_hipotecario, 
                                                                              antprestamo + mesprestamo AS prestamo, antafpgenesis + mesafpgenesis AS afpgenesis, antadmprevenir + mesadmprevenir AS admprevenir, antcafeteria + mescafeteria AS cafeteria, 
                                                                              antcelular + mescelular AS celular, antimp_renta + mesimp_renta AS imp_renta, antdesct_varios + mesdesct_varios AS desct_varios, 
																			 -- (CASE WHEN CH01CLASE = 'S' THEN (((antsueldoleyh + messueldoleyh) + (antotro + mesotro)) * (por_iva * 0.01)) ELSE 0 END) * (por_ret_iva * 0.01) AS valor_ret_iva, 
																			 -- (CASE WHEN CH01CLASE = 'S' THEN (((antsueldoleyh + messueldoleyh) + (antotro + mesotro)) * (por_ret_fuente * 0.01)) ELSE 0 END) AS ret_fuente, 
                                                                              antsueldoleyh + antsobretiempo + antcomision + antalimentacion + antotro + antreembolso + antdifsal + antvaca + antFR + antxiii + antxiv - antaporte_iess - antprestamo_quirografario - antprestamo_hipotecario
                                                                               - antprestamo - antafpgenesis - antadmprevenir - antcafeteria - antcelular - antimp_renta - antdesct_varios AS valor_anticipo, 
                                                                              messueldoleyh + messobretiempo + mescomision + mesalimentacion + mesotro + mesreembolso + mesdifsal + mesvaca + mesFR + mesxiii + mesxiv - mesaporte_iess - mesprestamo_quirografario - mesprestamo_hipotecario
                                                                               - mesprestamo - mesafpgenesis - mesadmprevenir - mescafeteria - mescelular - mesimp_renta - mesdesct_varios - leysolidaridad AS valor_mes, antimp_renta, mesimp_renta, leysolidaridad, 
                                                                              antleyh + mesleyh AS leyh
                                                    FROM            (SELECT        compania,  departamento,  anio, mes, --por_iva, por_ret_iva, por_ret_fuente, 
													SUM(antsueldo) AS antsueldo, SUM(messueldo) AS messueldo, SUM(antsueldoleyh) 
                                                                                                        AS antsueldoleyh, SUM(messueldoleyh) AS messueldoleyh, SUM(antsobretiempo) AS antsobretiempo, SUM(messobretiempo) AS messobretiempo, SUM(antcomision) AS antcomision, 
                                                                                                        SUM(mescomision) AS mescomision, SUM(antalimentacion) AS antalimentacion, SUM(mesalimentacion) AS mesalimentacion, SUM(antotro) AS antotro, SUM(mesotro) AS mesotro, 
                                                                                                        SUM(antreembolso) AS antreembolso, SUM(mesreembolso) AS mesreembolso, SUM(antdifsal) AS antdifsal, SUM(mesdifsal) AS mesdifsal, SUM(antvaca) AS antvaca, SUM(mesvaca) 
                                                                                                        AS mesvaca, SUM(adeiva) AS adeiva, SUM(mesiva) AS mesiva, SUM(antFR) AS antFR, SUM(mesFR) AS mesFR, SUM(antxiii) AS antxiii, SUM(mesxiii) AS mesxiii, SUM(antxiv) AS antxiv, 
                                                                                                        SUM(mesxiv) AS mesxiv, SUM(antaporte_iess) AS antaporte_iess, SUM(mesaporte_iess) AS mesaporte_iess, SUM(antprestamo_quirografario) AS antprestamo_quirografario, 
                                                                                                        SUM(mesprestamo_quirografario) AS mesprestamo_quirografario, SUM(antprestamo_hipotecario) AS antprestamo_hipotecario, SUM(mesprestamo_hipotecario) AS mesprestamo_hipotecario, 
                                                                                                        SUM(antprestamo) AS antprestamo, SUM(mesprestamo) AS mesprestamo, SUM(antafpgenesis) AS antafpgenesis, SUM(mesafpgenesis) AS mesafpgenesis, SUM(antadmprevenir) 
                                                                                                        AS antadmprevenir, SUM(mesadmprevenir) AS mesadmprevenir, SUM(antcafeteria) AS antcafeteria, SUM(mescafeteria) AS mescafeteria, SUM(antcelular) AS antcelular, SUM(mescelular) 
                                                                                                        AS mescelular, SUM(antimp_renta) AS antimp_renta, SUM(mesimp_renta) AS mesimp_renta, SUM(antdesct_varios) AS antdesct_varios, SUM(mesdesct_varios) AS mesdesct_varios, 
                                                                                                        SUM(leysolidaridad) AS leysolidaridad, SUM(antleyh) AS antleyh, SUM(mesleyh) AS mesleyh
                                                                              FROM            (SELECT        NH01CODCIA AS compania, NH01CODDEP AS departamento, YEAR(TH01FECPRO) AS anio, MONTH(TH01FECPRO) AS mes, 
                                                                                                                                  CH01CLASE AS clase, 
																																  --ROL_IVA AS por_iva, ROL_PORRETIVA AS por_ret_iva, 
                                  --                                                                                                ROL_PORRET AS por_ret_fuente, 
																																  ISNULL(NH01SDOFAS, 0) AS antsueldo, 0 AS messueldo, ISNULL(NH01SDOFAS, 0) - ISNULL(NH01SDESLEY, 0) AS antsueldoleyh, 
                                                                                                                                  0 AS messueldoleyh, ISNULL(NH01VALSOB, 0) + ISNULL(NH01VALSOB2, 0) + ISNULL(NH01VALSOB3, 0) AS antsobretiempo, 0 AS messobretiempo, ISNULL(NH01CCCOMI, 0) 
                                                                                                                                  AS antcomision, 0 AS mescomision, ISNULL(NH01ING001, 0) AS antalimentacion, 0 AS mesalimentacion, 
                                                                                                                                  CASE WHEN CH01CLASE = 'N' THEN NH01ING009 ELSE (CASE WHEN (((100 - isnull(ROL_PORRET, 0)) * 0.01) = 0) THEN 0 ELSE (NH01ING005 / ((100 - ROL_PORRET) * 0.01)) 
                                                                                                                                  END) END AS antotro, 0 AS mesotro, ISNULL(NH01ING004, 0) + ISNULL(NH01ING008, 0) + ISNULL(NH01MOVIL, 0) AS antreembolso, 0 AS mesreembolso, ISNULL(NH01ING002, 0) 
                                                                                                                                  AS antdifsal, 0 AS mesdifsal, ISNULL(NH01ING003, 0) AS antvaca, 0 AS mesvaca, CASE WHEN CH01CLASE = 'S' THEN isnull(ROL_SOBRETIVA, 0) ELSE 0 END AS adeiva, 
                                                                                                                                  0 AS mesiva, ISNULL(NH01FONRESMES, 0) AS antFR, 0 AS mesFR, ISNULL(ROL_XIII_VM, 0) AS antxiii, 0 AS mesxiii, ISNULL(ROL_XIV_VM, 0) AS antxiv, 0 AS mesxiv, 
                                                                                                                                  ISNULL(NH01APIESS, 0) AS antaporte_iess, 0 AS mesaporte_iess, ISNULL(NH01IESSQF, 0) AS antprestamo_quirografario, 0 AS mesprestamo_quirografario, 
                                                                                                                                  ISNULL(NH01IESSHP, 0) AS antprestamo_hipotecario, 0 AS mesprestamo_hipotecario, ISNULL(NH01PRESTA, 0) AS antprestamo, 0 AS mesprestamo, ISNULL(NH01ITEM02, 0) 
                                                                                                                                  AS antafpgenesis, 0 AS mesafpgenesis, ISNULL(NH01ITEM03, 0) AS antadmprevenir, 0 AS mesadmprevenir, ISNULL(NH01CXC003, 0) + ISNULL(NH01MULTAS, 0) AS antcafeteria, 
                                                                                                                                  0 AS mescafeteria, ISNULL(NH01ITEM01, 0) AS antcelular, 0 AS mescelular, (CASE WHEN ROL_CAT_IR IN ('B') THEN 0 ELSE isnull(NH01IMPREN, 0) END) AS antimp_renta, 
                                                                                                                                  0 AS mesimp_renta, ISNULL(NH01ITEM04, 0) + ISNULL(NH01ITEM05, 0) + ISNULL(NH01ITEM06, 0) + ISNULL(NH01ITEM07, 0) + ISNULL(NH01ITEM09, 0) + ISNULL(NH01ITEM08, 
                                                                                                                                  0) + ISNULL(NH01ITEM10, 0) + ISNULL(NH01CXC001, 0) + ISNULL(NH01CXC004, 0) + ISNULL(NH01DEBITOS, 0) - ISNULL(NH01SDESLEY, 0) AS antdesct_varios, 
                                                                                                                                  0 AS mesdesct_varios, 0 AS leysolidaridad, ISNULL(NH01SDESLEY, 0) AS antleyh, 0 AS mesleyh
                                                                                                        FROM            dbo.ROLH01 AS a
                                                                                                        WHERE        (DAY(TH01FECPRO) = 15)
                                                                                                        UNION ALL
                                                                                                        SELECT        NH01CODCIA AS compania,  NH01CODDEP AS departamento, YEAR(TH01FECPRO) AS anio, MONTH(TH01FECPRO) AS mes,  CH01CLASE AS clase,
                                                                                                                                 --ROL_IVA AS por_iva, 
																																 --ROL_PORRETIVA AS por_ret_iva, 
                                                                                                                               --  ROL_PORRET AS por_ret_fuente, 
																																 0 AS antsueldo, ISNULL(NH01SDOFAS, 0) AS messueldo, 0 AS antsueldoleyh, ISNULL(NH01SDOFAS, 0) - ISNULL(NH01SDESLEY, 0) 
                                                                                                                                 AS messueldoleyh, 0 AS antsobretiempo, ISNULL(NH01VALSOB, 0) + ISNULL(NH01VALSOB2, 0) + ISNULL(NH01VALSOB3, 0) AS messobretiempo, 0 AS antcomision, 
                                                                                                                                 ISNULL(NH01CCCOMI, 0) AS mescomision, 0 AS antalimentacion, ISNULL(NH01ING001, 0) AS mesalimentacion, 0 AS antotro, 
                                                                                                                                 CASE WHEN CH01CLASE = 'N' THEN NH01ING009 ELSE (CASE WHEN (((100 - isnull(ROL_PORRET, 0)) * 0.01) = 0) THEN 0 ELSE (NH01ING005 / ((100 - ROL_PORRET) * 0.01)) 
                                                                                                                                 END) END AS mesotro, 0 AS antreembolso, ISNULL(NH01ING004, 0) + ISNULL(NH01ING008, 0) + ISNULL(NH01MOVIL, 0) AS mesreembolso, 0 AS antdifsal, ISNULL(NH01ING002, 
                                                                                                                                 0) AS mesdifsal, 0 AS antvaca, ISNULL(NH01ING003, 0) AS mesvaca, 0 AS adeiva, CASE WHEN CH01CLASE = 'S' THEN isnull(ROL_SOBRETIVA, 0) ELSE 0 END AS mesiva, 
                                                                                                                                 0 AS antFR, ISNULL(NH01FONRESMES, 0) AS mesFR, 0 AS antxiii, ISNULL(ROL_XIII_VM, 0) AS mesxiii, 0 AS antxiv, ISNULL(ROL_XIV_VM, 0) AS mesxiv, 0 AS antaporte_iess, 
                                                                                                                                 ISNULL(NH01APIESS, 0) AS Expr1, 0 AS antprestamo_quirografario, ISNULL(NH01IESSQF, 0) AS mesprestamo_quirografario, 0 AS antprestamo_hipotecario, ISNULL(NH01IESSHP, 
                                                                                                                                 0) AS mesprestamo_hipotecario, 0 AS antprestamo, ISNULL(NH01PRESTA, 0) AS mesprestamo, 0 AS antafpgenesis, ISNULL(NH01ITEM02, 0) AS mesafpgenesis, 
                                                                                                                                 0 AS antadmprevenir, ISNULL(NH01ITEM03, 0) AS mesadmprevenir, 0 AS antcafeteria, ISNULL(NH01CXC003, 0) + ISNULL(NH01MULTAS, 0) AS mescafeteria, 0 AS antcelular, 
                                                                                                                                 ISNULL(NH01ITEM01, 0) AS mescelular, 0 AS antimp_renta, (CASE WHEN ROL_CAT_IR IN ('B') THEN 0 ELSE isnull(NH01IMPREN, 0) END) AS Expr2, 0 AS antdesct_varios, 
                                                                                                                                 ISNULL(NH01ITEM04, 0) + ISNULL(NH01ITEM05, 0) + ISNULL(NH01ITEM06, 0) + ISNULL(NH01ITEM07, 0) + ISNULL(NH01ITEM09, 0) + ISNULL(NH01ITEM08, 0) 
                                                                                                                                 + ISNULL(NH01ITEM10, 0) + ISNULL(NH01CXC001, 0) + ISNULL(NH01CXC004, 0) + ISNULL(NH01DEBITOS, 0) - ISNULL(NH01SDESLEY, 0) AS mesdesct_varios, 
                                                                                                                                 ISNULL(NH01CXC011, 0) AS leysolidaridad, 0 AS antleyh, ISNULL(NH01SDESLEY, 0) AS mesleyh
                                                                                                        FROM            dbo.ROLH01 AS a
                                                                                                        WHERE        (DAY(TH01FECPRO) > 15)) AS a
                                                                              GROUP BY compania, departamento,   anio, mes) AS b) AS c) AS x where anio = 2023 and mes = 6 order by departamento


